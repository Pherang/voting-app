<template>
  <main>
      <!-- Poll Main Content -->
    <div v-if="this.error">Error loading Poll</div>
    <div v-else>
      <h2 v-html="poll.question"></h2>
      <form @submit.prevent="submit">
        <div v-for="answer in poll.answers">
          <input 
            name="poll._id" 
            type="radio" 
            :value="answer.option" 
            v-model="option"> 
            {{ answer.option }}
          </input> 
          Votes: {{ answer.votes }}
        </div>
        <button 
          type="button" 
          @click="deletePoll" 
          v-if=this.isOwner>
          Delete Poll</button>
        <div v-if="this.voted">Thanks for Voting!</div>
        <button 
          :disabled="!this.option" 
          v-else type="submit">
          Submit Vote
        </button>
      </form>
    </div>
  </main>    
</template>

<script>
export default {
  props: [
    'poll',
  ],
  data () {
    return {
      option: '',
      voted: false,
      error: null
    }
  },
  computed: {
    isOwner () {
      return (this.poll.creator === this.$state.user._id)
    }
  },
  methods: {
    async submit () {
      try {
        const result = await fetch('http://localhost:4040/vote', {
         method: 'POST',
         headers: {
          'Content-Type': 'application/json'
         },
         body: JSON.stringify( {
            pollid: this.poll._id,
            option: this.option
         })
        })

        if (result.ok) {
          console.log('Vote submitted')
          this.voted = true;
        } else {
          throw new Error('error')
        }
      } catch (err) {
        console.log('Vote error: ', err)
      }
    },
    async deletePoll () {
      console.log('TODO Delete Poll')
    }
  }
}
</script>

<style scoped>

</style>
